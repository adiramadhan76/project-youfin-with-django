{% extends 'page/base.html' %}
{% load static %}
{% load humanize %}

{% block title %} Dashboard {% endblock %}

{% block style_dashboard %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        /* Container utama anggaran */
        .sisa-anggaran {
            margin: 20px 0;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .sisa-anggaran-2 .text-wrapper-10 {
            font-size: 1.5rem;
            font-weight: bold;
            color: #343a40;
            margin-bottom: 15px;
        }
        
        /* Kontainer progress bar */
        .budget-progress-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }
        
        .budget-progress-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Header */
        .budget-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1rem;
            color: #555;
            font-weight: bold;
        }
        
        .budget-progress-title {
            display: flex;
            align-items: center;
            color: #495057;
            font-weight: bold;
        }
        
        .budget-progress-title i {
            color: #6c757d;
            margin-right: 5px;
        }
        
        .budget-progress-period {
            font-size: 0.9rem;
            color: #777;
        }
        
        /* Progress bar container */
        .budget-progress-wrapper {
            position: relative;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .budget-progress-bar {
            height: 100%;
            transition: width 1s ease-in-out;
        }
        
        .budget-progress-bar.success {
            background-color: #28a745;
        }
        
        .budget-progress-bar.warning {
            background-color: #ffc107;
        }
        
        .budget-progress-bar.danger {
            background-color: #dc3545;
        }
        
        /* Detail anggaran */
        .budget-progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            color: #555;
            margin-bottom: 5px;
        }
        
        .budget-progress-details span {
            font-weight: bold;
        }
        
        .budget-progress-remaining {
            font-size: 0.95rem;
            color: #495057;
            font-weight: bold;
        }
        
        .budget-progress-remaining span {
            color: #6c757d;
        }

        .text-danger {
            color: #dc3545; /* Warna merah untuk pengeluaran */
        }

        .text-success {
            color: #28a745; /* Warna hijau untuk pemasukan */
        }
        </style>
                
{% endblock %}
{% block your_content_here %}

<div class="overlap">
    <div class="rekening">
        <!-- Alert Messages -->
        <div class="message-box">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-dismissible fade show {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}"
                     role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        <div class="text-wrapper-5">
            <i class="bi bi-wallet2" style="margin-right: 4px;"></i> Rekening
        </div>

        <div class="a-n-rekening">
            <div class="overlap-group-2">
                <div class="name">
                    <p class="a-n-alex-turner">
                        <span class="text-wrapper">A.n</span>
                        <span class="span">&nbsp;</span>
                        <span class="text-wrapper-2">{{ request.user.first_name }} {% if request.user.last_name %}{{ request.user.last_name }}{% endif %}</span>
                    </p>
                    <div class="text-wrapper-3">Tgl Pembuatan : {{ request.user.date_joined|date:"d/m/Y" }}</div>
                </div>
                <div class="text-wrapper-4">Saldo Bersih: Rp {{ saldo_bersih|intcomma }}</div>
            </div>
        </div>
    </div>

    <!-- Transaksi Ringkasan -->
    <div class="transaksi">
        <div class="group">
            <div class="outcome">
                <div class="text-wrapper-6">Pengeluaran</div><br>
                <i class="bi bi-arrow-up-circle" style="color: red; font-size: x-large;"></i>
                <div class="text-wrapper-7"><br>Rp {{ total_pengeluaran|intcomma }}</div>
            </div>
            <div class="income">
                <div class="text-wrapper-8">Pemasukan</div><br>
                <i class="bi bi-arrow-down-circle" style="color: green; font-size: x-large;"></i>
                <div class="text-wrapper-9"><br>Rp {{ total_pemasukan|intcomma }}</div>
            </div>
        </div>
    </div>

    <!-- Transaksi Terbaru -->
    <div class="transaksi-terbaru card shadow-sm">
        <div class="card-header bg-white py-3 d-flex align-items-center">
            <i class="bi bi-clock-history me-2 text-secondary"></i>
            <h5 class="card-title mb-0">Transaksi Terbaru</h5>
        </div><br>
        <!-- Grafik Pengeluaran dan Pemasukan Bulanan -->
        <div class="group-3">
            <div class="chart-container" style="margin: auto;">
                <h2 style="text-align: center;">Grafik Batang - Transaksi 5 hari terakhir</h2>
                <canvas id="chart-transactions"></canvas>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="list-group list-group-flush">
                {% for transaction in transaksi_terbaru %}
                <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                    <div class="d-flex flex-column">
                        <div class="text-wrapper-12 
                            {% if transaction.transaction_type == 'Pengeluaran' %}text-danger{% else %}text-success{% endif %} 
                            mb-1 fw-bold">
                            {{ transaction.transaction_type }}
                        </div><hr>
                        <small class="text-muted">{{ transaction.name }}</small>
                    </div>
                    <div class="text-end">
                        <div class="text-wrapper-11 
                            {% if transaction.transaction_type == 'Pengeluaran' %}text-danger{% else %}text-success{% endif %} 
                            fw-bold">
                            {% if transaction.transaction_type == 'Pengeluaran' %}-{% endif %}Rp {{ transaction.amount|intcomma }}
                        </div>
                        <!-- <small class="text-muted d-block">
                            {% with time_diff=current_time|timeuntil:transaction.date %}
                                {% if time_diff == '0 menit' %}
                                    Baru saja
                                {% else %}
                                    {{ time_diff }} yang lalu
                                {% endif %}
                            {% endwith %}
                        </small> -->
                    </div>
                </div>
                {% empty %}
                <div class="list-group-item text-center text-muted py-3">
                    <p class="mb-0">Belum ada transaksi</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Anggaran -->
    <div class="sisa-anggaran">
        <div class="sisa-anggaran-2">
            <div class="text-wrapper-10">
                <i class="bi bi-cash-stack" style="margin-right: 4px;"></i> Anggaran
            </div> 
            {% for budget in budgets %}
            <div class="budget-progress-container">
                <div class="budget-progress-header">
                    <div class="budget-progress-title">
                        <i class="bi bi-cash-stack me-2"></i>{{ budget.category.name }}
                    </div>
                    <div class="budget-progress-period">
                        {{ budget.bulan }}/{{ budget.tahun }}
                    </div>
                </div>
            
                <div class="budget-progress-wrapper">
                    <div 
                        class="budget-progress-bar 
                        {% if budget.spent_percentage > 100 %}danger
                        {% elif budget.spent_percentage >= 80 %}warning
                        {% else %}success{% endif %}" 
                        style="width: {{ budget.spent_percentage|floatformat:0 }}%;">
                    </div>
                </div>
            
                <div class="budget-progress-details">
                    <span class="budget-progress-spent">
                        Dihabiskan: Rp {{ budget.total_expenses|intcomma }}
                    </span>
                    <span class="budget-progress-total">
                        Anggaran: Rp {{ budget.initial_budget|intcomma }}
                    </span>
                </div>
            
                <div class="budget-progress-remaining">
                    Sisa Anggaran: Rp {{ budget.remaining_balance|intcomma }} 
                    ({{ budget.spent_percentage|floatformat:1 }}% terpakai)
                </div>
            </div>
            {% endfor %}   
        </div>
    </div>
</div>

{% endblock %}

{% block script_dashboard %}
    <script>
        const ctx = document.getElementById('chart-transactions').getContext('2d');
        const chartTransactions = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [{% for transaction in transaksi_terbaru %} '{{ transaction.transaction_type }}', {% endfor %}],
                datasets: [
                    {
                        label: 'Transaksi',
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        data: [{% for transaction in transaksi_terbaru %} '{{ transaction.amount }}', {% endfor %}],
                    },
                ],
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true },
                },
            },
        });
    </script>

{% endblock %}
